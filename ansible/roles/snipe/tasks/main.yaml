---
- name: Check for compose file
  ansible.builtin.stat:
    path: /usr/lib/snipe/docker-compose.yaml
  register: compose_stat

- name: Teardown existing infrastructure
  community.docker.docker_compose_v2:
    project_src: /usr/lib/snipe
    state: absent
  when: compose_stat.stat.exists

- name: Create directories
  ansible.builtin.file:
    path: /usr/lib/snipe
    state: directory
    mode: u=rw,g=r,o=r
    owner: ctrmgr
    group: ctrmgr

- name: Copy compose file
  ansible.builtin.template:
    src: docker-compose.yaml.j2
    dest: /usr/lib/snipe/docker-compose.yaml
    mode: u=rw,g=,o=
    owner: ctrmgr
    group: ctrmgr
    backup: true

- name: Start new infrastructure
  community.docker.docker_compose_v2:
    project_src: /usr/lib/snipe
